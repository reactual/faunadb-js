<!DOCTYPE html>

<html>
<head>
  <title>Client.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>Client.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-meta">'use strict'</span>;

<span class="hljs-keyword">var</span> btoa = <span class="hljs-built_in">require</span>(<span class="hljs-string">'btoa-lite'</span>);
<span class="hljs-keyword">var</span> request = <span class="hljs-built_in">require</span>(<span class="hljs-string">'superagent'</span>);
<span class="hljs-keyword">var</span> errors = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./errors'</span>);
<span class="hljs-keyword">var</span> objects = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./Value'</span>);
<span class="hljs-keyword">var</span> json = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./_json'</span>);
<span class="hljs-keyword">var</span> RequestResult = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./RequestResult'</span>);
<span class="hljs-keyword">var</span> util = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./_util'</span>);
<span class="hljs-keyword">var</span> PageHelper = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./PageHelper'</span>);
<span class="hljs-keyword">var</span> <span class="hljs-built_in">Promise</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'es6-promise'</span>).Promise;

<span class="hljs-comment">/**
 * The callback that will be executed after every completed request.
 *
 * @callback Client~observerCallback
 * @param {RequestResult} res
 */</span>

<span class="hljs-comment">/**
 * A client for interacting with FaunaDB.
 *
 * All methods return a typed JSON object representing a FaunaDB response.
 * Literal types in the response object will remain as strings, Arrays, and objects.
 * FaunaDB types, such as {@link Ref}, {@link SetRef}, {@link FaunaTime}, and {@link FaunaDate} will
 * be converted into the appropriate type.
 *
 * (So instead of `{ "@ref": "classes/frogs/123" }`,
 * you will get `new Ref("classes/frogs/123")`.)
 *
 * @constructor
 * @param {?Object} options
 *   Object that configures this FaunaDB client.
 * @param {?string} options.domain
 *   Base URL for the FaunaDB server.
 * @param {?('http'|'https')} options.scheme
 *   HTTP scheme to use.
 * @param {?number} options.port
 *   Port of the FaunaDB server.
 * @param {?Object} options.secret
 *   Auth token for the FaunaDB server.
 *   Uses the same format as [request](https://github.com/request/request#http-authentication).
 * @param {?string} options.secret.user Username, or FaunaDB secret.
 * @param {?string} options.secret.pass If `user` is a username, the corresponding password.
 * @param {?number} options.timeout Read timeout in seconds.
 * @param {?Client~observerCallback} options.observer
 *   Callback that will be called after every completed request.
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Client</span>(<span class="hljs-params">options</span>) </span>{
  <span class="hljs-keyword">var</span> opts = util.applyDefaults(options, {
    domain: <span class="hljs-string">'rest.faunadb.com'</span>,
    scheme: <span class="hljs-string">'https'</span>,
    port: <span class="hljs-literal">null</span>,
    secret: <span class="hljs-literal">null</span>,
    timeout: <span class="hljs-number">60</span>,
    observer: <span class="hljs-literal">null</span>
  });

  <span class="hljs-keyword">if</span> (opts.port === <span class="hljs-literal">null</span>) {
    opts.port = opts.scheme === <span class="hljs-string">'https'</span> ? <span class="hljs-number">443</span> : <span class="hljs-number">80</span>;
  }

  <span class="hljs-keyword">this</span>._baseUrl = opts.scheme + <span class="hljs-string">'://'</span> + opts.domain + <span class="hljs-string">':'</span> + opts.port;
  <span class="hljs-keyword">this</span>._timeout = <span class="hljs-built_in">Math</span>.floor(opts.timeout * <span class="hljs-number">1000</span>);
  <span class="hljs-keyword">this</span>._secret = opts.secret;
  <span class="hljs-keyword">this</span>._observer = opts.observer;
}

<span class="hljs-comment">/**
 * Executes a query via the FaunaDB Query API.
 * See the [docs](https://faunadb.com/documentation/queries),
 * and the query functions in this documentation.
 * @param expression {Expr}
 *   The query to execute. Created from query functions such as {@link add}.
 * @return {external:Promise&lt;Object&gt;} FaunaDB response object.
 */</span>
Client.prototype.query = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">expression</span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._execute(<span class="hljs-string">'POST'</span>, <span class="hljs-string">''</span>, expression);
};

<span class="hljs-comment">/**
 * Returns a {@link PageHelper} for the given Query expression.
 * This provides a helpful API for paginating over FaunaDB responses.
 * @param expression {Expr}
 *   The Query expression to paginate over.
 * @param params {Object}
 *   Options to be passed to the paginate function. See [paginate](https://faunadb.com/documentation/queries#read_functions).
 * @returns {PageHelper} A PageHelper that wraps the provided expression.
 */</span>
Client.prototype.paginate = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">expression, params</span>) </span>{
  params = defaults(params, {});

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> PageHelper(<span class="hljs-keyword">this</span>, expression, params);
};

<span class="hljs-comment">/**
 * Issues a HTTP `GET` request via the legacy REST API.
 * See the [docs](https://faunadb.com/documentation/rest).
 * @deprecated Use the {@link Client#query} API where possible.
 * @param {string|Ref} path Path relative the `domain` from the constructor.
 * @param {Object} query URL parameters.
 * @return {external:Promise&lt;Object&gt;} FaunaDB response object.
 */</span>
Client.prototype.get = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">path, query</span>) </span>{
  query = defaults(query, <span class="hljs-literal">null</span>);
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._execute(<span class="hljs-string">'GET'</span>, path, <span class="hljs-literal">null</span>, query);
};

<span class="hljs-comment">/**
 * Issues a HTTP `POST` request via the legacy REST API.
 * See the [docs](https://faunadb.com/documentation/rest).
 * @deprecated Use the {@link Client#query} API where possible.
 * @param {string|Ref} path Path relative to the `domain` from the constructor.
 * @param {Object} data Object to be converted to request JSON.
 * @return {external:Promise&lt;Object&gt;} FaunaDB response object.
 */</span>
Client.prototype.post = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">path, data</span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._execute(<span class="hljs-string">'POST'</span>, path, data);
};

<span class="hljs-comment">/**
 * Issues a HTTP `PUT` request via the legacy REST API.
 * See the [docs](https://faunadb.com/documentation/rest).
 * @deprecated Use the {@link Client#query} API where possible.
 * @param {string:Ref} path Path relative to the `domain` from the constructor.
 * @param {Object} data Object to be converted to the request JSON.
 * @return {external:Promise&lt;Object&gt;} FaunaDB response object.
 */</span>
Client.prototype.put = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">path, data</span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._execute(<span class="hljs-string">'PUT'</span>, path, data);
};

<span class="hljs-comment">/**
 * Issues a HTTP `PATCH` request via the legacy REST API.
 * See the [docs](https://faunadb.com/documentation/rest).
 * @deprecated Use the {@link Client#query} API where possible.
 * @param {string:Ref} path Path relative to the `domain` from the constructor.
 * @param {Object} data Object to be converted to the request JSON.
 * @return {external:Promise&lt;Object&gt;} FaunaDB response object.
 */</span>
Client.prototype.patch = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">path, data</span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._execute(<span class="hljs-string">'PATCH'</span>, path, data);
};

<span class="hljs-comment">/**
 * Issues a HTTP `DELETE` request via the legacy REST API.
 * See the [docs](https://faunadb.com/documentation/rest).
 * @deprecated Use the {@link Client#query} API where possible.
 * @param {string:Ref} path Path relative to the `domain` from the constructor.
 * @return {external:Promise&lt;Object&gt;} FaunaDB response object.
 */</span>
Client.prototype.delete = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">path</span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._execute(<span class="hljs-string">'DELETE'</span>, path);
};

<span class="hljs-comment">/**
 * Sends a `ping` request to FaunaDB.
 * See the [docs](https://faunadb.com/documentation/rest#other).
 * @return {external:Promise&lt;string&gt;} Ping response.
 */</span>
Client.prototype.ping = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">scope, timeout</span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'ping'</span>, { scope: scope, timeout: timeout });
};

Client.prototype._execute = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">action, path, data, query</span>) </span>{
  query = defaults(query, <span class="hljs-literal">null</span>);

  <span class="hljs-keyword">if</span> (path <span class="hljs-keyword">instanceof</span> objects.Ref) {
    path = path.value;
  }

  <span class="hljs-keyword">if</span> (query !== <span class="hljs-literal">null</span>) {
    query = util.removeUndefinedValues(query);
  }

  <span class="hljs-keyword">var</span> startTime = <span class="hljs-built_in">Date</span>.now();
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._performRequest(action, path, data, query).then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">response</span>) </span>{
    <span class="hljs-keyword">var</span> endTime = <span class="hljs-built_in">Date</span>.now();
    <span class="hljs-keyword">var</span> responseObject = json.parseJSON(response.text);
    <span class="hljs-keyword">var</span> requestResult = <span class="hljs-keyword">new</span> RequestResult(
      self,
      action, path, query, data,
      response.text, responseObject, response.status, response.header,
      startTime, endTime);

    <span class="hljs-keyword">if</span> (self._observer != <span class="hljs-literal">null</span>) {
      self._observer(requestResult);
    }

    errors.FaunaHTTPError.raiseForStatusCode(requestResult);
    <span class="hljs-keyword">return</span> responseObject[<span class="hljs-string">'resource'</span>];
  });
};

Client.prototype._performRequest = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">action, path, data, query</span>) </span>{
  <span class="hljs-keyword">var</span> rq = request(action, <span class="hljs-keyword">this</span>._baseUrl + <span class="hljs-string">'/'</span> + path);
  <span class="hljs-keyword">if</span> (query) {
    rq.query(query);
  }

  <span class="hljs-keyword">if</span> (data) {
    rq.send(data);
  }

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._secret) {
    rq.set(<span class="hljs-string">'Authorization'</span>, secretHeader(<span class="hljs-keyword">this</span>._secret));
  }

  rq.timeout(<span class="hljs-keyword">this</span>._timeout);

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">resolve, reject</span>) </span>{
    rq.end(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">error, result</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>superagent treates 4xx and 5xx status codes as exceptions. Weâ€™ll handle those ourselves.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (error &amp;&amp;
          error.response &amp;&amp;
          !(error.response.status &gt;= <span class="hljs-number">400</span> &amp;&amp; error.response.status &lt;= <span class="hljs-number">599</span>)) {
        reject(error);
      } <span class="hljs-keyword">else</span> {
        resolve(result);
      }
    });
  });
};

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">defaults</span>(<span class="hljs-params">obj, def</span>) </span>{
  <span class="hljs-keyword">if</span> (obj === <span class="hljs-literal">undefined</span>) {
    <span class="hljs-keyword">return</span> def;
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> obj;
  }
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">secretHeader</span>(<span class="hljs-params">secret</span>) </span>{
  <span class="hljs-keyword">var</span> str = <span class="hljs-string">'pass'</span> <span class="hljs-keyword">in</span> secret ? secret.user + <span class="hljs-string">':'</span> + secret.pass : secret.user;
  <span class="hljs-keyword">return</span> <span class="hljs-string">'Basic '</span> + btoa(str);
}

<span class="hljs-built_in">module</span>.exports = Client;</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
